<!DOCTYPE html>
<html lang="en">
<head>
<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    background-color: #EEE;
}
#container {
    display: flex;
}
.list-container {
    margin: 10px;
    padding: 10px;
    background-color: white;
}
.chosen-list {
    margin-top: 0px;
    font-size: 2em;
    padding-inline-start: 0px;
    list-style: none;
    border-bottom: 1px solid;
}
ol.unchosen-list {
    list-style: circle;
    padding-inline-start: 20px;
}
ol.unchosen-list:before {
    content: attr(aria-label);
    font-style: italic;
    margin: -20px;
    opacity: 0.3;
}
</style>
</head>
<body>
<div id="container">

    <!-- <h3>Unchosen options</h3>
    <textarea id="options"></textarea> -->
</div>

<script>
    const ALWAYS_EMPTY_SET = new Set();
    main();

    function main() {
        getListStrings().forEach(listString => {
            const {numberToChoose, options} = getOptions(listString);
            console.log('numberToChoose', numberToChoose)
            const chosenIndexes = chooseFromOptions({numberToChoose, options});
            render({options, chosenIndexes});
        });
    }

    function getListStrings() {
        const rawHashString = window.location.hash.replace(/^#/, '');
        return rawHashString.split(';');
    }

    function getOptions(listString) {
        const [fullMatch, number, options] =  listString.match(/^([0-9]from:)?(.*)/);
        return {
            numberToChoose: parseInt(number),
            options: decodeURIComponent(options).split(','),
        };
    }

    function chooseFromOptions({options, numberToChoose, chosenIndexes, unchosenIndexesObject}) {
        if (!Number.isInteger(numberToChoose) || numberToChoose < 1) {
            numberToChoose = 1;
        }
        chosenIndexes = chosenIndexes || new Set();
        unchosenIndexesObject = unchosenIndexesObject || createIndexesObject(options);
        const unchosenIndexes = Object.keys(unchosenIndexesObject);

        const newIndexOfIndex = getRandomIntegerUpTo(unchosenIndexes.length - 1);
        const choiceIndex = parseInt(unchosenIndexes[newIndexOfIndex]);
        delete unchosenIndexesObject[choiceIndex];
        chosenIndexes.add(choiceIndex);
        numberToChoose -= 1;
        if (numberToChoose > 0 && unchosenIndexes.length > 1) {
            return chooseFromOptions({options, numberToChoose, chosenIndexes, unchosenIndexesObject});
        }
        return chosenIndexes;
    }

    function createIndexesObject(options) {
        const indexesObject = {};
        options.forEach((o, index) => {
            indexesObject[index] = '';
        });
        return indexesObject;
    }

    function getRandomIntegerUpTo(max) {
        const randomNumber = Math.random(); // 0 to 1
        const randomNumberScaled = randomNumber * max;
        return Math.round(randomNumberScaled);
    }

    function render({options, chosenIndexes}) {
        const listContainer = document.createElement('div');
        listContainer.classList.add('list-container')
        const chosen = [];
        const unchosen = [];
        options.forEach((option, index) => {
            const list = chosenIndexes.has(index) ? chosen : unchosen;
            list.push(option);
        });
        listContainer.append(renderChosenList(chosen));
        listContainer.append(renderOtherOptionsList(unchosen));

        const container = document.getElementById('container');
        container.append(listContainer); // FIXME need a replace later on to avoid multiple sets of list being added
    }

    function renderChosenList(chosenList) {
        return renderList({
            list: chosenList,
            className: 'chosen-list',
            // title: "Chosen:"
        });
    }

    function renderOtherOptionsList(options) {
        // const optionsTextArea = document.querySelector('#options');
        // optionsTextArea.value = options.join('\n');
        // optionsTextArea.rows = options.length;
        return renderList({
            list: options,
            className: 'unchosen-list',
            title: '(unchosen options)'
        });
    }

    function renderList({list, className, title}) {
        const listElement = document.createElement('ol');
        title && listElement.setAttribute('aria-label', title);
        className && listElement.classList.add(className);
        list.forEach(item => {
            listElement.append(
                renderItem(item)
            );
        });
        return listElement;
    }

    function renderItem(text) {
        const item = document.createElement('li');
        item.textContent = text;
        return item;
    }

</script>

<script src="/assets/js/googleAnalytics.js"></script>
</body>
</html>
